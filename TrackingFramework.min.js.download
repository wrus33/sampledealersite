"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function _inherits(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var _extends=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}();DDC.classes.namespace("tracking.framework.runtime"),tracking.framework.runtime.Page=function(e){this.dataLayerHelper=e},tracking.framework.runtime.Page.prototype={constructor:tracking.framework.runtime.Page,isPageType:function(e,n){if(void 0===n){var n=this.currentPageAlias();return void 0!==n&&e(n)?!0:(n=this.currentPageId(),void 0!==n&&e(n))}return e.call(this,n)},isNewVehiclePage:function(e){return this.isPageType(function(e){return e.indexOf("_NEW")>-1},e)},isCertifiedUsedVehiclePage:function(e){return this.isPageType(function(e){return e.indexOf("_CERTIFIED_USED")>-1},e)},isUsedVehiclePage:function(e){return this.isPageType(function(e){return e.indexOf("_USED")>-1},e)},isIndexPage:function(e){return this.isPageType(function(e){return"INDEX"===e},e)},isVehicleListingPage:function(e){return this.isPageType(function(e){return e.indexOf("INVENTORY_LISTING")>-1},e)},isVehicleDetailPage:function(e){return this.isPageType(function(e){return 0==e.indexOf("AUTO_")&&e.indexOf("_DETAILS")>-1},e)},isIncentivesPage:function(e){return this.isPageType(function(e){return e.indexOf("INCENTIVES")>-1},e)},isHoursOrDirectionsPage:function(e){return this.isPageType(function(e){return e.indexOf("HOURS")>-1||e.indexOf("DIRECTIONS")>-1},e)},isAboutOrStaffPage:function(e){return this.isPageType(function(e){return e.indexOf("ABOUT")>-1||e.indexOf("STAFF_LISTING")>-1||e.indexOf("EMPLOYMENT_LISTING")>-1},e)},isContactPage:function(e){return this.isPageType(function(e){return e.indexOf("CONTACT")>-1},e)},isComparePage:function(e){return this.isPageType(function(e){return e.indexOf("INVENTORY_COMPARE")>-1},e)},isTradeInPage:function(e){return this.isPageType(function(e){return e.indexOf("TRADE")>-1&&!(e.indexOf("CONFIRM")>-1)},e)},isToolPage:function(e){return this.isPageType(function(e){return this.isComparePage(e)||e.indexOf("CALCULATOR_PAYMENT")>-1||this.isTradeInPage(e)||e.indexOf("INVENTORY_FINDER")>-1},e)},isOffersPage:function(e){return this.isPageType(function(e){return-1==e.indexOf("PARTS")&&e.indexOf("SPECIALS")>-1||e.indexOf("COUPON")>-1||this.isIncentivesPage(e)},e)},isServicePage:function(e){return this.isPageType(function(e){return!this.isOffersPage(e)&&e.indexOf("SERVICE")>-1||e.indexOf("PARTS")>-1||e.indexOf("MOPAR")>-1||e.indexOf("XTIME")>-1},e)},isFinancePage:function(e){return this.isPageType(function(e){return!this.isOffersPage(e)&&e.indexOf("FINANCE")>-1||e.indexOf("FINANCING")>-1},e)},isCorporatePage:function(e){return this.isPageType(function(e){return e.indexOf("PRIVACY")>-1||e.indexOf("LEGAL")>-1||e.indexOf("SITEMAP")>-1},e)},isBrochurePage:function(e){return this.isPageType(function(e){return e.indexOf("BROCHURE")>-1||e.indexOf("POCKET_GUIDE")>-1},e)},isConfirmationPage:function(e){return e.indexOf("CONFIRM")>-1},isErrorPage:function(e){return e.indexOf("404")>-1},isNoResultsPage:function(e){return this.isPageType(function(e){return e.indexOf("NO_RESULTS")>-1},e)},isModelShowroomPage:function(){return this.dataLayerProperty("page.pageInfo.isShowroomOverview")},isVideoGalleryPage:function(e){return this.isPageType(function(e){return e.indexOf("VIDEO_GALLERY")>-1},e)},dataLayerProperty:function(e){return this.dataLayerHelper.get(e)},currentPageAlias:function(){return this.dataLayerProperty("page.pageInfo.pageName")},currentPageId:function(){return this.dataLayerProperty("page.pageInfo.pageId")},widgetIsPresent:function(e){var n=this.dataLayerProperty("page.pageInfo.pageWidgets");for(var t in n)if(e.test(n[t]))return!0;return!1},queryFacetIsPresent:function(e){for(var n in e)if(e.hasOwnProperty(n)&&void 0!==e[n])return!0;return!1},setLocalStorage:function(e,n){localStorage.setItem(e,JSON.stringify(n))},getLocalStorage:function(e){var n,t=localStorage.getItem(e);if(!t)return t;if(n=JSON.parse(t),n.element){var i=document.createElement("div");i.innerHTML=n.element,n.element=i.firstChild}return n},removeLocalStorage:function(e){localStorage.removeItem(e)}},DDC.classes.namespace("tracking.framework.runtime"),tracking.framework.runtime.Command=function(e,n,t){this.log=com.dealer.log.Logger.createFor(this),this.window=e,this.page=n,this.eventHandler=t},tracking.framework.runtime.Command.prototype={constructor:tracking.framework.runtime.Command,logCategory:"Command",execute:function(){}},DDC.classes.namespace("tracking.framework.runtime"),tracking.framework.runtime.EventHandler=function(e,n){this.log=com.dealer.log.Logger.createFor(this),this.window=e,this.page=n,this.widgetId=void 0},tracking.framework.runtime.EventHandler.prototype={constructor:tracking.framework.runtime.EventHandler,logCategory:"EventHandler",handlePageView:function(){},handleVehicleDetailView:function(){},handleSlideshowClick:function(){},handleAjaxContentLoad:function(){},handleDialogOpened:function(){},handleDialogClosed:function(){},handleDRIntegratedClick:function(){},handleDRLeadFormStart:function(){},handleFormChange:function(){},handleTypedSearch:function(){},handleTypedSearchInit:function(){},handleTypedSearchResults:function(){},handlePaymentCalcInit:function(){},handleFormConfirmation:function(){},handleFormInitiation:function(){},handleAjaxFormConfirm:function(){},handleFormOnPage:function(){},handleFormSubmission:function(){},handleClickToCall:function(){},handleComparePageClick:function(){},handleHproductClick:function(){},handleRecommendedVehicleClick:function(){},handleMycarsLogin:function(){},handleMycarsSave:function(){},handleMycarsGetAlerts:function(){},handleMycarsCompareCheck:function(){},handleMycarsCompareSubmit:function(){},handleOfferClick:function(){},handleNavigationClick:function(){},handleFilterSearch:function(){},handleFilterSearchClick:function(){},handleIncentiveFilter:function(){},handleLinkClick:function(){},handleMapClick:function(){},handleSocialHeaderClick:function(){},handleSocialShare:function(){},handleGetDirections:function(){},handleSpecialsEvent:function(){},handleWidgetUserEvent:function(){},handleAllWidgetUserEvents:function(){},handleVehicleCompareCheck:function(){},handleVideoPlay:function(){},handleVideoMilestone:function(){},handleDRPaymentCalcClick:function(){},handleSlideshowPagerClick:function(){}},DDC.classes.namespace("tracking.framework.runtime"),tracking.framework.runtime.EventHandlerDecorator=function(e){function n(e,t,i){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e,t));return r.delegate=i,r}return _inherits(n,e),n}(tracking.framework.runtime.EventHandler),tracking.framework.runtime.EventHandlerDecorator.prototype.logCategory="EventHandlerDecorator";var eventHandlerPrototype=tracking.framework.runtime.EventHandler.prototype;Object.keys(eventHandlerPrototype).filter(function(e){return 0===e.indexOf("handle")&&"function"==typeof eventHandlerPrototype[e]}).forEach(function(e){tracking.framework.runtime.EventHandlerDecorator.prototype[e]=function(n){this.delegate[e](n)}}),DDC.classes.namespace("tracking.framework.runtime"),tracking.framework.runtime.InteractionListener=function(){var e={"ddc.page.view":"handlePageView","ddc.page.vehicleDetailView":"handleVehicleDetailView","ddc.inventory.filterSearch":"handleFilterSearch","ddc.inventory.filterSearch.click":"handleFilterSearchClick","ddc.inventory.typedSearch":"handleTypedSearchResults","ddc.inventory.typedSearch.init":"handleTypedSearchInit","ddc.incentive.filterSearch":"handleIncentiveFilter","ddc.slideshow.click":"handleSlideshowClick","ddc.slideshow.pagerClick":"handleSlideshowPagerClick","ddc.dialog.ajaxContentLoaded":"handleAjaxContentLoad","ddc.dialog.opened":"handleDialogOpened","ddc.dialog.closed":"handleDialogClosed","ddc.drIntegrated.click":"handleDRIntegratedClick","ddc.drIntegrated.leadFormStart":"handleDRLeadFormStart","ddc.drPaymentCalc.click":"handleDRPaymentCalcClick","ddc.form.facetBrowseChange":"handleFormChange","ddc.form.inventorySearchLeadChange":"handleFormChange","ddc.form.typedSearch":"handleTypedSearch","ddc.form.paymentCalcInit":"handlePaymentCalcInit","ddc.form.confirmation":"handleFormConfirmation","ddc.form.initiation":"handleFormInitiation","ddc.form.onPage":"handleFormOnPage","ddc.form.ajaxFormConfirm":"handleAjaxFormConfirm","ddc.form.submission":"handleFormSubmission","ddc.form.change":"handleFormChange","ddc.form.slideChange":"handleFormChange","ddc.link.generic":"handleLinkClick","ddc.link.clickToCall":"handleClickToCall","ddc.link.comparePageClick":"handleComparePageClick","ddc.link.hproductClick":"handleHproductClick","ddc.link.mycarsLogin":"handleMycarsLogin","ddc.link.mycarsSave":"handleMycarsSave","ddc.link.mycarsGetAlerts":"handleMycarsGetAlerts","ddc.link.mycarsCompareCheck":"handleMycarsCompareCheck","ddc.link.mycarsCompareSubmit":"handleMycarsCompareSubmit","ddc.link.offerClick":"handleOfferClick","ddc.link.navClick":"handleNavigationClick","ddc.link.recommendedVehicle":"handleRecommendedVehicleClick","ddc.link.socialHeaderClick":"handleSocialHeaderClick","ddc.link.socialShare":"handleSocialShare","ddc.link.getDirections":"handleGetDirections","ddc.link.vehicleCompareCheck":"handleVehicleCompareCheck","ddc.maps":"handleMapClick","ddc.video.play":"handleVideoPlay","ddc.video.milestone":"handleVideoMilestone",specialsEvent:"handleSpecialsEvent",widgetUserEvent:"handleAllWidgetUserEvents"},n=function(){function n(e,t,i){_classCallCheck(this,n),this.log=new com.dealer.log.Logger("InteractionListener"),this.window=e,this.page=t,this.eventHandlers=Array.isArray(i)?i:[i]}return _createClass(n,[{key:"addEventHandlers",value:function(){for(var e=this,n=arguments.length,t=Array(n),i=0;n>i;i++)t[i]=arguments[i];t.forEach(function(n){n instanceof tracking.framework.runtime.EventHandler?(e.log.debug("adding new event handler "+n.logCategory),e.eventHandlers.push(n)):e.log.warn('could not add event handler "'+n+'"')})}},{key:"onDataPushed",value:function(n,t){var i="object"===_typeof(t.eventData)?t.eventData:t,r=e[t.event];i.eventSource=t.event,"string"==typeof r&&(this.log.info("handling "+t.event+" event"),this.notifyHandlers(r,i))}},{key:"notifyHandlers",value:function(e,n){var t=this;this.eventHandlers.forEach(function(i){try{t.log.debug("initiating call to "+i.logCategory+"."+e),i[e](n)}catch(r){t.log.error("error when calling "+i.logCategory+"."+e),console.error(r)}})}},{key:"isNewTrackEventFormat",value:function(e){return!!(e.widgetName&&e.element&&e.action&&e.result)}},{key:"observeWidgetUserEvents",value:function(){var e=this;$(document).on("trackEvent",function(n,t,i){if("undefined"!=typeof t&&"widgetUserEvent"===t.event&&e.isNewTrackEventFormat(t)){e.log.info("handling Osiris "+t.event+" event");var r=_extends({optionalData:_extends({},i)},t);e.notifyHandlers("handleWidgetUserEvent",r)}})}},{key:"initialize",value:function(){var e=this;this.log.info("listening to DataLayer events"),new DataLayerHelper(this.window.dataLayer,function(n,t){e.onDataPushed(n,t)},!0),this.log.info("listening to Widget User Events"),this.observeWidgetUserEvents()}}]),n}();return n}(),DDC.classes.namespace("tracking.framework.config"),tracking.framework.config.Injector=function(){this.log=new com.dealer.log.Logger("Injector")},tracking.framework.config.Injector.prototype={constructor:tracking.framework.config.Injector,capitalize:function(e){return e.charAt(0).toUpperCase()+e.substring(1)},decapitalize:function(e){return e.charAt(0).toLowerCase()+e.substring(1)},setterFor:function(e,n){var t="set"+this.capitalize(n);return e[t]},setProperties:function(e,n){for(var t in n)if(n.hasOwnProperty(t)){var i=n[t],r=this.setterFor(e,t);void 0!==r?(this.log.isDebugEnabled()&&this.log.debug("using setter injection to set "+t+" to: "+JSON.stringify(i)),r.call(e,i)):(this.log.isDebugEnabled()&&this.log.debug("using field injection to set "+t+" to: "+JSON.stringify(i)),e[t]=i)}return e},initialize:function(e,n,t){if(n=void 0===n?"initialize":n,t=void 0===t?!1:t,void 0!==e[n]&&"function"==typeof e[n])this.log.debug("invoking "+n+"()"),e[n].call(e);else{if(t)throw new Error("Initializer not found: "+n+"()");this.log.debug("initializer not found: "+n+"()")}return e}},tracking.framework.config.Injector.singleton=new tracking.framework.config.Injector,tracking.framework.config.Injector.get=function(){return tracking.framework.config.Injector.singleton},DDC.classes.namespace("tracking.framework.config"),tracking.framework.config.Component=function(e,n){this.log=new com.dealer.log.Logger("Component"),this.injector=tracking.framework.config.Injector.get(),this.definition=e||{},this.defaults=n||{}},tracking.framework.config.Component.prototype={constructor:tracking.framework.config.Component,withDefinition:function(e,n){return this.definition=e||{},this.defaults=n||{},this},className:function(){if(void 0!==this.definition.className)return this.definition.className;if(void 0!==this.defaults.className)return this.defaults.className;throw new Error("Failed to determine class from component definition")},properties:function(){return void 0!==this.definition.properties?this.definition.properties:void 0!==this.defaults.properties?this.defaults.properties:void 0},initializer:function(){return void 0!==this.definition.initializer?this.definition.initializer:void 0!==this.defaults.initializer?this.defaults.initializer:void 0},instantiate:function(e,n,t){t=void 0===t?!1:t;var i=this.className();this.log.debug("instantiating "+i);var r=n.call(e,DDC.classes.resolve(i)),a=this.properties();void 0!==a&&(this.log.debug("injecting configured properties into "+i),this.injector.setProperties(r,a));var o=this.initializer();return(t||void 0!==o)&&(this.log.debug("attempting to invoke "+i+"."+o+"()"),this.injector.initialize(r,o,t)),r}},DDC.classes.namespace("tracking.framework.config"),tracking.framework.config.RuntimeBuilder=function(){var e={},n=function(e,n){return"object"===("undefined"==typeof e?"undefined":_typeof(e))&&"object"===("undefined"==typeof n?"undefined":_typeof(n))&&Object.keys(e).length===Object.keys(n).length&&Object.keys(e).every(function(t){return e[t]===n[t]})},t=function(){function t(e,n){_classCallCheck(this,t),this.log=new com.dealer.log.Logger("RuntimeBuilder"),this.component=new tracking.framework.config.Component,this.window=e,this.configuration=n}return _createClass(t,[{key:"buildDataLayer",value:function(){this.log.debug("building data layer..."),this.window.dataLayer=this.window.dataLayer||[this.window.DDC.dataLayer],this.log.debug("data layer built.")}},{key:"buildPage",value:function(){this.log.debug("building page...");var e=this.component.withDefinition(this.configuration.page,{className:"tracking.framework.runtime.Page"}).instantiate(this,function(e){var n=this.window.DDC.Flags||{};return new e(new DataLayerHelper(n.useDdcDatalayer?[this.window.DDC.dataLayer]:this.window.dataLayer))},!1);return this.log.debug("page built."),e}},{key:"buildEventHandler",value:function(e){this.log.debug("building event handler...");var n=this.component.withDefinition(this.configuration.eventHandler,{initializer:"initialize"}).instantiate(this,function(n){return new n(this.window,e)},!1);return this.log.debug("event handler built."),n}},{key:"buildDecoratorChain",value:function(e,n){if(this.log.debug("building decorator chain..."),void 0!==this.configuration.decorators)for(var t=this.configuration.decorators.length-1;t>=0;t--)n=this.component.withDefinition(this.configuration.decorators[t],void 0).instantiate(this,function(t){return new t(this.window,e,n)},!1);return this.log.debug("decorator chain built."),n}},{key:"buildInteractionListener",value:function(e,n){var t=this.configuration.interactionListener||{className:"tracking.framework.runtime.InteractionListener",initializer:"initialize"},i=this.getComponent(t);return"undefined"==typeof i?(this.log.debug("building interaction listener..."),i=this.component.withDefinition(t).instantiate(this,function(t){return new t(this.window,e,n)},!0),this.log.debug("interaction listener built."),this.setComponent(t,i)):i.addEventHandlers(n),i}},{key:"buildStartupCommands",value:function(e,n){var t=[];if(this.log.debug("building startup commands..."),void 0!==this.configuration.startupCommands)for(var i=0;i<this.configuration.startupCommands.length;i++)t.push(this.component.withDefinition(this.configuration.startupCommands[i],void 0).instantiate(this,function(t){return new t(this.window,e,n)},!1));return this.log.debug("startup commands built..."),t}},{key:"getComponent",value:function(t){var i=e[t&&t.className];if(i)for(var r=0;r<i.length;r++)if(n(t,i[r].configuration))return this.log.debug("retrieving identical "+t.className+" component"),i[r].component}},{key:"setComponent",value:function(n,t){n&&n.className&&t&&(this.log.debug("adding new "+n.className+" component to container"),e[n.className]=e[n.className]||[],e[n.className].push({configuration:n,component:t}))}}],[{key:"getContainer",value:function(){return e}},{key:"clearContainer",value:function(){for(var n in e)e.hasOwnProperty(n)&&delete e[n]}}]),t}();return t}(),DDC.classes.namespace("tracking.framework.config"),tracking.framework.config.Main=function(){function e(n){_classCallCheck(this,e),this.log=new com.dealer.log.Logger("Main"),this.builder=n,this.page=void 0,this.eventHandler=void 0,this.decoratorChain=void 0,this.listener=void 0}return _createClass(e,[{key:"assembleRuntimeComponents",value:function(){this.log.debug("assembling runtime components..."),this.builder.buildDataLayer(),this.page=this.builder.buildPage(),this.eventHandler=this.builder.buildEventHandler(this.page),this.decoratorChain=this.builder.buildDecoratorChain(this.page,this.eventHandler),this.listener=this.builder.buildInteractionListener(this.page,this.decoratorChain),this.log.debug("runtime components assembled.")}},{key:"executeStartupCommands",value:function(){var e=this.builder.buildStartupCommands(this.page,this.eventHandler);if(void 0!==e&&e.length>0){this.log.debug("executing startup commands...");for(var n=0;n<e.length;n++){var t=e[n];t.execute()}this.log.debug("startup commands executed.")}}},{key:"execute",value:function(){this.assembleRuntimeComponents(),this.executeStartupCommands()}}]),e}();