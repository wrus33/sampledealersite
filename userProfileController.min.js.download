!function(e){"use strict";var r=window.DDC=window.DDC||{};r.userProfileController=window.DDC.userProfileController=window.DDC.userProfileController||{},r.userProfile={};var o=!1,i="drUserSession",t="/apis/mycars/v2/profiles/",l={firstName:'[name="contact.firstName"]',lastName:'[name="contact.lastName"]',email:'[name="contact.email"]',phone:'[name="contact.phone"]',preferred:'[name="contact.preferredContact"] [value="phone"]',postalCode:'[name="contact.address.postalCode"]'},s=r.siteProperties.enableConsolidatedLeadForms;r.userProfileController.initEvents=function(){e.subscribe("mycars-logged-in",function(){if(o=!0,sessionStorage.dr_inline_leadForm){var t=JSON.parse(sessionStorage.getItem("dr_inline_leadForm"));t.hasSubmittedLeadForm=!1,sessionStorage.setItem("dr_inline_leadForm",JSON.stringify(t))}if(sessionStorage.getItem(i)){var l=JSON.parse(sessionStorage.getItem(i));l.profileId=e.cookie("userProfileId"),r.userProfileController.saveProfile(l,function(){sessionStorage.removeItem(i),r.userProfileController.loadProfile()},!1,"LoggingIn")}else r.userProfileController.loadProfile()}),e.subscribe("mycars-logged-out",function(){o=!1,r.userProfileController.loadProfile()}),e.subscribe("mycars-user-logging-out",function(){o=!1,r.userProfile={},sessionStorage.removeItem(i),sessionStorage.removeItem("drProtectComplete"),sessionStorage.removeItem("dr_inline_leadForm"),sessionStorage.removeItem("drUserSession")})},r.userProfileController.applyVehicleOfInterest=function(e,r){return r&&(e.vehicleOfInterest={},e.vehicleOfInterest.itemUUID=r),e},r.userProfileController.applyContactInfoToProfile=function(e){return r.siteProperties.enableConsolidatedLeadForms&&(e.firstName=r.userProfile.firstName,e.lastName=r.userProfile.lastName),e},r.userProfileController.hasUserContactData=function(e){return e=e||!1,r.userProfile.firstName&&r.userProfile.lastName&&(e?r.userProfile.email:r.userProfile.email||r.userProfile.phone)?!0:!1},r.userProfileController.fillContactForm=function(e){return r.userProfile&&e&&(e.find(l.firstName).val(r.userProfile.firstName),e.find(l.lastName).val(r.userProfile.lastName),e.find(l.email).val(r.userProfile.email),e.find(l.phone).val(r.userProfile.phone),e.find(l.postalCode).val(r.userProfile.postalCode),r.userProfileController.hasUserContactData())?(r.userProfile.email||e.find(l.preferred).attr("selected","selected").closest(":input").trigger("change"),!0):!1},r.userProfileController.populateProfileFormFields=function(e){r.userProfile&&e&&s&&(r.userProfile.firstName=e.find(l.firstName).val(),r.userProfile.lastName=e.find(l.lastName).val(),r.userProfile.email=e.find(l.email).val(),r.userProfile.phone=e.find(l.phone).val(),r.userProfile.postalCode=e.find(l.postalCode).val()||"")},r.userProfileController.sendLeadForm=function(o){o&&e.ajax({url:o,type:"get",dataType:"html"}).then(function(o){var i=e(o).find('form[data-form-tracking-id="INSTANT_EPRICE"]');r.userProfileController.fillContactForm(i),e.ajax({url:i.attr("action"),type:"post",dataType:"html",data:i.serialize()})})},r.userProfileController.saveTrade=function(e,o,i,t,l){r.userProfileController.populateProfileFormFields(e);var s=r.userProfileController.applyVehicleOfInterest({ownedVehicle:o,leadReferenceId:t},i);s=r.userProfileController.applyContactInfoToProfile(s),s.ownedVehicle.valuations[0].thirdPartyAttributes.serie||(s.ownedVehicle.valuations[0].thirdPartyAttributes.serie=""),r.userProfileController.saveProfile(s,l)},r.userProfileController.saveAccessories=function(e,o,i){var t={};t.vehicleAccessories=e,t=r.userProfileController.applyVehicleOfInterest(t,o),t=r.userProfileController.applyContactInfoToProfile(t),r.userProfile.vehicleAccessories&&r.userProfile.vehicleAccessories[o]&&(r.userProfile.vehicleAccessories[o]={}),r.userProfileController.saveProfile(t,i)},r.userProfileController.addProgress=function(e,o,i,t){var l={};l[e.type]={},l[e.type].state=e,l[e.type].type=e.type,r.userProfile&&r.userProfile.progress&&r.userProfile.progress[e.type]&&r.userProfile.progress[e.type].id&&(l[e.type].id=r.userProfile.progress[e.type].id);var s=r.userProfileController.applyVehicleOfInterest({progress:l,leadReferenceId:i},o);r.userProfileController.saveProfile(s,t)},r.userProfileController.savePayment=function(e,o,i,t,l){r.userProfileController.populateProfileFormFields(e);var s=r.userProfileController.applyVehicleOfInterest({paymentQuotes:o,leadReferenceId:t},i);s=r.userProfileController.applyContactInfoToProfile(s),s.phoneNumber=r.userProfile.phone,r.userProfile,r.userProfileController.saveProfile(s,l)},r.userProfileController.saveReservation=function(e,o){var i=r.userProfileController.applyVehicleOfInterest({vehicleReservations:e},o);r.userProfileController.saveProfile(i)},r.userProfileController.savePrequal=function(e,o,i,t,l){var s=r.userProfileController.applyVehicleOfInterest({preQualification:e,leadReferenceId:i},o);r.userProfileController.saveProfile(s,t,l)},r.userProfileController.saveProtectionPlan=function(e,o,i,t,l,s){r.userProfileController.populateProfileFormFields(e);var a=r.userProfileController.applyVehicleOfInterest({protectionPlan:o,protectionPlanSource:i,leadReferenceId:l},t);a=r.userProfileController.applyContactInfoToProfile(a),r.userProfileController.saveProfile(a,s)},r.userProfileController.saveApplication=function(e,o,i,t,l){var s=r.userProfileController.applyVehicleOfInterest({creditApplication:e,leadReferenceId:i},o);r.userProfileController.saveProfile(s,t,l)},r.userProfileController.saveInstantEpriceVehicle=function(e,o){r.userProfileController.populateProfileFormFields(e);var i={itemUUID:o};r.userProfile.ePriceVehicles||(r.userProfile.ePriceVehicles=[]),r.userProfile.ePriceVehicles.push(i),r.userProfileController.saveProfile(i)},r.userProfileController.loadProfile=function(){var l=e.cookie("userProfileId"),a={},n=r&&r.pubsub;if(o){var u=window.DDC.getSiteProperty("Tier2Region");u&&(a.Tier2Region=u),e.ajax({type:"GET",url:t+l,cache:!1,data:a,contentType:"application/json",headers:{"X-EPrice-Page-Size":50},success:function(o){r.userProfile=o,s&&sessionStorage.setItem(i,JSON.stringify(r.userProfile)),e.publish("userProfile-updated"),n&&window.DDC.pubsub.publish("userProfile-updated"),e.publish("userProfile-loaded")},error:function(){console.warn("unable to load the profile data")}})}else r.userProfile=sessionStorage.getItem(i)?JSON.parse(sessionStorage.getItem(i)):{},e.publish("userProfile-updated"),n&&window.DDC.pubsub.publish("userProfile-updated")},r.userProfileController.saveProfile=function(l,a,n,u){n="undefined"==typeof n?!0:n;var f=e.cookie("userProfileId"),c=r&&r.pubsub;if(o){var p=JSON.stringify(l);e.ajax({type:"POST",url:t+f,data:p,dataType:"json",contentType:"application/json",disableDDCAutoAppend:!0,beforeSend:function(e){e.setRequestHeader("MyCarsAction","upsert"),e.setRequestHeader("MyCarsSaveProfileEvent",u)},success:function(o){if(r.userProfile=o,s){if(r.userProfile&&r.userProfile.progress)for(var t=Object.keys(r.userProfile.progress),l=0;l<t.length;l++)delete r.userProfile.progress[t[l]].state["manual-save"];sessionStorage.setItem(i,JSON.stringify(r.userProfile))}n&&(e.publish("userProfile-updated"),c&&window.DDC.pubsub.publish("userProfile-updated")),a&&a.call()},error:function(e,r){console.warn("failed to save profile data %o with status of %s",p,r)}})}else e.extend(!0,r.userProfile,l),sessionStorage.setItem(i,JSON.stringify(r.userProfile)),n&&(e.publish("userProfile-updated"),c&&window.DDC.pubsub.publish("userProfile-updated")),a&&a.call()},r.userProfileController.generateSanitizedProfile=function(){var e={};if(r.userProfile.leadReferenceId&&(e.leadReferenceId=r.userProfile.leadReferenceId),r.userProfile.email&&(e.contact={email:r.userProfile.email,firstName:r.userProfile.firstName,lastName:r.userProfile.lastName}),r.userProfile.vehicleOfInterest&&(e.vehicle={itemUUID:r.userProfile.vehicleOfInterest.itemUUID},r.userProfile.vehicleOfInterest.attributes&&(e.vehicle.title=r.userProfile.vehicleOfInterest.attributes.title,e.vehicle.detailsURL=r.userProfile.vehicleOfInterest.attributes.detailsURL,e.vehicle.imageUri=r.userProfile.vehicleOfInterest.attributes.imageUri)),r.digitalRetailing.summary.trade&&(e.trade={complete:r.digitalRetailing.summary.trade.complete},r.userProfile.ownedVehicle)){var o=r.userProfile.ownedVehicle.valuations;if(e.trade.make=r.userProfile.ownedVehicle.make,e.trade.year=r.userProfile.ownedVehicle.year,o&&o.length>0){var i=o[o.length-1];e.trade.model=i.thirdPartyAttributes.model,"undefined"!=typeof i.thirdPartyAttributes.serie&&(e.trade.style=i.thirdPartyAttributes.serie+" "),e.trade.style+=i.thirdPartyAttributes.style,e.trade.style=e.trade.style.trim(),e.trade.offer=i.offer,e.trade.source=i.source}}if(r.digitalRetailing.summary.payment&&(e.payment={complete:r.digitalRetailing.summary.payment.complete},r.userProfile.paymentQuotes&&r.userProfile.paymentQuotes[e.vehicle.itemUUID])){var t=r.userProfile.paymentQuotes[e.vehicle.itemUUID];e.payment.apr=t.apr,e.payment.date=t.date,e.payment.monthlyPayment=t.monthlyPayment,e.payment.term=t.term,e.payment.type=t.type,e.payment.source=t.source,e.payment.estimatedCreditScore=t.estimatedCreditScore,e.payment.totalTax=t.totalTax,e.payment.nonCappedDealerFees=t.nonCappedDealerFees,e.payment.cappedDealerFees=t.cappedDealerFees,e.payment.acquisitionFee=t.acquisitionFee,e.payment.rebate=t.rebate,e.payment.leaseMoneyFactor=t.leaseMoneyFactor,e.payment.leaseResidualPercentage=t.leaseResidualPercentage,e.payment.leaseResidualValue=t.leaseResidualValue,e.payment.leaseAnnualMileage=t.leaseAnnualMileage,e.payment.requestLoanAPR=t.requestLoanAPR}if(r.digitalRetailing.summary.prequal&&(e.prequal={complete:r.digitalRetailing.summary.prequal.complete},r.userProfile.preQualification&&(e.prequal.date=r.userProfile.preQualification.date,e.prequal.approved=r.userProfile.preQualification.approved||r.userProfile.preQualification.status,e.prequal.referenceNumber=r.userProfile.preQualification.referenceNumber,e.prequal.source=r.userProfile.preQualification.source)),r.digitalRetailing.summary.finance&&(e.credit={complete:r.digitalRetailing.summary.finance.complete},r.userProfile.creditApplication&&(e.credit.date=r.userProfile.creditApplication.date,e.credit.referenceNumber=r.userProfile.creditApplication.referenceNumber,e.credit.source=r.userProfile.creditApplication.source)),r.digitalRetailing.summary.reserve&&(e.reserve={complete:r.digitalRetailing.summary.reserve.complete},r.userProfile.vehicleReservations&&r.userProfile.vehicleReservations[e.vehicle.itemUUID])){var l=r.userProfile.vehicleReservations[e.vehicle.itemUUID];e.reserve.amount=l.amount,e.reserve.date=l.date,e.reserve.vendor=l.vendor}return r.digitalRetailing.summary.protect&&(e.protect={complete:r.digitalRetailing.summary.protect.complete},r.userProfile.protectionPlan&&(e.protect.items=r.userProfile.protectionPlan),r.userProfile.protectionPlanSource&&(e.protect.source=r.userProfile.protectionPlanSource)),e},r.userProfileController.generateAnonProfile=function(o){e.ajax({type:"POST",url:"/apis/mycars/v1/profiles",data:JSON.stringify({source:"ANONYMOUS"}),dataType:"json",contentType:"application/json",beforeSend:function(e){e.setRequestHeader("MyCarsAction","create")},success:function(e){o&&o(e)},error:function(e,o){r.log(e,o)}})},e(document).ready(function(){r.userProfileController.initEvents()})}(jQuery);